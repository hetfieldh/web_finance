<!--- app/templates/extratos/bancario.html -->

{% extends "base.html" %}

{% block title %}Web Finance - Extratos{% endblock %}
{% block page_title %}Extrato Bancário{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card shadow-sm mb-2">
            <div class="card-body">
                <form method="POST"
                    action="{{ url_for('extrato.extrato_bancario') }}">
                    {{ form.csrf_token }}
                    <div class="row align-items-end">
                        <div class="col-md-4 mb-2 mb-md-0">
                            {{ form.conta_id.label(class="form-label") }}
                            {{ form.conta_id(class="form-select form-select-sm")
                            }}
                            {% if form.conta_id.errors %}
                            <div class="text-danger">
                                {% for error in form.conta_id.errors %}{{ error
                                }}{% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        <div class="col-md-2 mb-2 mb-md-0">
                            {{ form.mes_ano.label(class="form-label") }}
                            {{ form.mes_ano(class="form-select form-select-sm")
                            }}
                            {% if form.mes_ano.errors %}
                            <div class="text-danger">
                                {% for error in form.mes_ano.errors %}{{ error
                                }}{% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        <div class="col-md-2">
                            <button type="submit"
                                class="btn btn-success btn-add">
                                <i class="fas fa-search me-1"></i> {{
                                form.submit.label.text }}
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        {% if movimentacoes or (form.is_submitted() and conta_selecionada) %}

        <!-- Card de Resumo do Mês -->
        <div class="card shadow-sm mb-2">
            <div class="card-body">
                <div class="row g-0 text-center align-items-center">
                    <div class="col-lg col-md-6">
                        <h6 class="text-muted small mb-0">Saldo Anterior</h6>
                        <p class="h6 mb-0">R$ {{ "%.2f"|format(saldo_anterior)
                            }}</p>
                    </div>
                    <div class="col-lg col-md-6">
                        <h6 class="text-muted small mb-0">Créditos no Mês</h6>
                        <p class="h6 text-success mb-0">R$ {{
                            "%.2f"|format(total_creditos) }}</p>
                    </div>
                    <div class="col-lg col-md-6 mt-2 mt-lg-0">
                        <h6 class="text-muted small mb-0">Débitos no Mês</h6>
                        <p class="h6 text-danger mb-0">R$ {{
                            "%.2f"|format(total_debitos) }}</p>
                    </div>
                    <div class="col-lg col-md-6 mt-2 mt-lg-0">
                        <h6 class="text-muted small mb-0">Limite Disponível</h6>
                        <p class="h6 mb-0">R$ {{ "%.2f"|format(limite_conta if
                            limite_conta else 0) }}</p>
                    </div>
                    <div class="col-lg col-md-12 mt-2 mt-lg-0">
                        <div
                            class="card {% if saldo_final_mes >= 0 %}bg-success-subtle border-success{% else %}bg-danger-subtle border-danger{% endif %}">
                            <div class="card-body p-0">
                                <h6 class="card-title extra-small mb-0">Saldo
                                    Final</h6>
                                <p class="card-text h6 fw-bold mb-0">R$ {{
                                    "%.2f"|format(saldo_final_mes) }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-header bg-secondary text-white">
                <h6 class="mb-0">Extrato de {{ conta_selecionada.nome_banco }} -
                    {{ conta_selecionada.conta }} ({{ conta_selecionada.tipo
                    }})</h6>
            </div>
            <div class="card-body">
                {% if movimentacoes %}
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Tipo Transação</th>
                                <th>Movimento</th>
                                <th>Valor</th>
                                <th>Descrição</th>
                                <th>Saldo Acumulado</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for mov in movimentacoes %}
                            <tr>
                                <td>{{mov.data_movimento.strftime('%d/%m/%Y')}}</td>
                                <td>{{ mov.tipo_transacao_nome }}</td>
                                <td>
                                    {% if mov.tipo_movimento == 'Crédito' %}
                                    <span class="badge bg-success">{{
                                        mov.tipo_movimento }}</span>
                                    {% elif mov.tipo_movimento == 'Débito' %}
                                    <span class="badge bg-danger">{{
                                        mov.tipo_movimento }}</span>
                                    {% else %}
                                    {{ mov.tipo_movimento }}
                                    {% endif %}
                                </td>
                                <td
                                    class="{% if mov.tipo_movimento == 'Débito' %}text-danger{% else %}text-success{% endif %}">
                                    {% if mov.tipo_movimento == 'Débito' %}-{%
                                    endif %}R$ {{ "%.2f"|format(mov.valor) }}
                                </td>
                                <td>{{ mov.descricao if mov.descricao else
                                    'N/A'}}</td>
                                <td
                                    class="fw-bold {% if mov.saldo_acumulado < 0 %}text-danger{% endif %}">
                                    R$ {{ "%.2f"|format(mov.saldo_acumulado) }}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-center alert alert-info mt-3">Nenhuma
                    movimentação encontrada para o período selecionado.</p>
                {% endif %}
            </div>
        </div>
        {% elif form.is_submitted() and not movimentacoes and not
        conta_selecionada %}

        {% endif %}
    </div>
</div>
{% endblock %}
