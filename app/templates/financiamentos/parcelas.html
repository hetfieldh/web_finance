<!-- app/templates/financiamentos/parcelas.html -->

{% extends "base.html" %} {% block content %}
<div class="row">
  <div class="col-12">
    <div class="card shadow-sm mb-2">
      <div
        class="card-header bg-dark text-white d-flex justify-content-between align-items-center"
      >
        <h5 class="mb-0">
          <i class="fas fa-chart-pie me-2"></i>Resumo do Financiamento
        </h5>
        <a
          href="{{ url_for('financiamento.listar_financiamentos') }}"
          class="btn btn-cinza"
        >
          <i class="fas fa-arrow-left"></i> Voltar
        </a>
      </div>
      {% if financiamento and financiamento.descricao %}
      <div
        class="px-2 py-1 text-success fst-italic"
        style="background-color: var(--wf-box-bg2)"
      >
        <i class="fas text-success fa-info-circle me-2"></i>
        {{ financiamento.descricao }}
      </div>
      {% endif %}
      <div class="card-body">
        <h6
          class="card-title fw-semibold p-1 rounded"
          style="
            color: var(--wf-azul-destaque);
            background-color: var(--wf-azul-claro);
          "
        >
          Visão: Fluxo de Caixa (Valores Totais de Parcela)
        </h6>
        <div class="row text-center">
          <div class="col border-end">
            <small class="text-muted">Total Previsto</small>
            <p class="h5 fw-semibold mb-0">
              {{ resumo_fluxo_caixa.total_previsto | format_currency }}
            </p>
          </div>
          <div class="col border-end">
            <small class="text-muted">Pago</small>
            <p class="h5 fw-semibold text-success mb-0">
              {{ resumo_fluxo_caixa.Pago | format_currency }}
            </p>
          </div>
          <div class="col border-end">
            <small class="text-muted">Amortizado</small>
            <p class="h5 fw-semibold text-info mb-0">
              {{ resumo_fluxo_caixa.Amortizado | format_currency }}
            </p>
          </div>
          <div class="col border-end">
            <small class="text-muted">Pendente</small>
            <p class="h5 fw-semibold text-warning mb-0">
              {{ resumo_fluxo_caixa.Pendente | format_currency }}
            </p>
          </div>
          <div class="col">
            <small class="text-muted">
              {% if resumo_fluxo_caixa.diferenca > 0 %} Descontos Obtidos {%
              elif resumo_fluxo_caixa.diferenca < 0 %} Custos Extras {% else %}
              Diferença {% endif %}
            </small>
            <p
              class="h5 fw-semibold {% if resumo_fluxo_caixa.diferenca > 0 %}text-success{% elif resumo_fluxo_caixa.diferenca < 0 %}text-danger{% endif %} mb-0"
            >
              {{ resumo_fluxo_caixa.diferenca|abs|format_currency }}
            </p>
          </div>
        </div>

        <hr class="my-2" />

        <h6
          class="card-title fw-semibold p-1 rounded"
          style="
            color: var(--wf-azul-destaque);
            background-color: var(--wf-azul-claro);
          "
        >
          Visão: Balanço do Principal (Amortização da Dívida)
        </h6>
        <div class="row text-center">
          <div class="col border-end">
            <small class="text-muted">Valor do Contrato</small>
            <p class="h5 fw-semibold mb-0">
              {{ resumo_principal.total_contrato | format_currency }}
            </p>
          </div>
          <div class="col border-end">
            <small class="text-muted">Pago (Principal)</small>
            <p class="h5 fw-semibold text-success mb-0">
              {{ resumo_principal.Pago | format_currency }}
            </p>
          </div>
          <div class="col border-end">
            <small class="text-muted">Amortizado</small>
            <p class="h5 fw-semibold text-info mb-0">
              {{ resumo_principal.Amortizado | format_currency }}
            </p>
          </div>
          <div class="col border-end">
            <small class="text-muted">Pendente (Principal)</small>
            <p class="h5 fw-semibold text-warning mb-0">
              {{ resumo_principal.Pendente | format_currency }}
            </p>
          </div>
          <div class="col">
            <small class="text-muted">Saldo Devedor</small>
            <p class="h5 fw-bold text-danger mb-0">
              {{ resumo_principal.saldo_devedor | format_currency }}
            </p>
          </div>
        </div>
      </div>
    </div>

    <div class="card shadow-sm">
      <div class="card-body">
        {% if parcelas_com_saldo_dinamico %}
        <div class="table-responsive">
          <table class="table table-striped table-hover">
            <thead>
              <tr>
                <th class="text-center">#</th>
                <th class="text-center">Vencimento</th>
                <th class="text-end">Amortização (Principal)</th>
                <th class="text-end">Juros</th>
                <th class="text-end">Seguros/Taxas</th>
                <th class="text-end">Total Previsto</th>
                <th class="text-end">Valor Pago</th>
                <th class="text-end">Saldo Devedor</th>
                <th class="text-center">Status</th>
                <th class="text-start">Observações</th>
              </tr>
            </thead>
            <tbody>
              {% for item in parcelas_com_saldo_dinamico %}
              <tr>
                <td class="text-center">{{ item.parcela.numero_parcela }}</td>
                <td class="text-center">
                  {{ item.parcela.data_vencimento.strftime('%d/%m/%Y') }}
                </td>
                <td class="text-end">
                  {{ item.parcela.valor_principal | format_currency }}
                </td>
                <td class="text-end">
                  {{ item.parcela.valor_juros | format_currency }}
                </td>
                <td class="text-end">
                  {{ (item.parcela.valor_seguro + item.parcela.valor_seguro_2 +
                  item.parcela.valor_seguro_3 + item.parcela.valor_taxas) |
                  format_currency }}
                </td>
                <td class="fw-bold text-end">
                  {{ item.parcela.valor_total_previsto | format_currency }}
                </td>
                <td class="fw-bold text-success text-end">
                  {% if item.parcela.valor_pago %} {{ item.parcela.valor_pago |
                  format_currency }} {% else %} - {% endif %}
                </td>
                <td
                  class="fw-bold text-end {{ 'text-secondary' if item.parcela.status in ['Pago', 'Amortizado'] else 'text-danger' }}"
                >
                  {% if item.parcela.status in ['Pago', 'Amortizado'] %} - {%
                  else %} {{ item.saldo_devedor_dinamico | format_currency }} {%
                  endif %}
                </td>
                <td class="text-center">
                  {% if item.parcela.status == 'Pago' %}<span
                    class="badge bg-success"
                    >{{ item.parcela.status }}</span
                  >
                  {% elif item.parcela.status == 'Atrasado' %}<span
                    class="badge bg-danger"
                    >{{ item.parcela.status }}</span
                  >
                  {% elif item.parcela.status == 'Amortizado' %}<span
                    class="badge bg-info"
                    >{{ item.parcela.status }}</span
                  >
                  {% else %}<span class="badge bg-secondary"
                    >{{ item.parcela.status }}</span
                  >
                  {% endif %}
                </td>
                <td class="text-start">{{ item.parcela.observacoes or '' }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
        <div class="alert alert-warning text-center">
          Nenhuma parcela encontrada.
          <a
            href="{{ url_for('financiamento.importar_parcelas', id=financiamento.id) }}"
            class="alert-link"
            >Clique aqui para importá-las</a
          >.
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}
