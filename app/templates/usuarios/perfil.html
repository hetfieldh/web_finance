<!--- app\templates\usuarios\perfil.html -->

{% extends "base.html" %} {% from "includes/_macros.html" import render_field %}
{% block content %}
  {% if current_user.precisa_alterar_senha %}
    <div class="alert alert-warning" role="alert">
      <strong>Atenção!</strong>
      Por motivos de segurança, você precisa definir uma nova senha para ter acesso completo ao sistema.
    </div>
  {% endif %}

  <div class="row">
    <div class="col-md-8 mx-auto">
      <div class="card shadow-sm">
        <div class="card-header bg-warning">
          <h5 class="mb-0 d-flex align-items-center">
            <i class="fas fa-exclamation-triangle fa-lg mx-2 text-dark"></i>
            <span class="flex-grow-1 text-center">Editar Informações do Perfil Atual</span>
          </h5>
        </div>
        <div class="card-body">
          <form method="POST" action="{{ url_for('usuario.perfil') }}" data-user-id="{{ current_user.id }}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
            <div class="row">
              <div class="col-md-6 mb-3">{{ render_field(form.nome) }}</div>
              <div class="col-md-6 mb-3">{{ render_field(form.sobrenome) }}</div>
            </div>
            <div class="row">
              <div class="col-md-7 mb-3">
                {{ render_field(form.email, attrs={'id': 'email'}) }}
                <div id="email-feedback" class="form-text mt-1"></div>
              </div>
              <div class="col-md-5 mb-3">{{ render_field(form.login) }}</div>
            </div>

            <hr />

            {% if current_user.precisa_alterar_senha %}
              <h6 class="text-danger">Defina a sua nova senha</h6>
              <div class="row">
                <div class="col-md-6 mb-3">
                  {{
                    render_field(form.nova_senha, label='Senha', attrs={'id':
                    'senha', 'required': true})
                  }}
                  {% if form.nova_senha.errors %}
                    <div class="text-danger">{% for error in form.nova_senha.errors %}{{ error }}{% endfor %}</div>
                  {% endif %}
                </div>
                <div class="col-md-6 mb-3">
                  {{
                    render_field(form.confirmar_nova_senha, label='Confirmar
                    Senha', attrs={'id': 'confirmar_senha', 'required': true})
                  }}
                </div>
              </div>
            {% else %}
              <h6 class="text-muted">Alterar Senha (opcional)</h6>
              <p class="text-muted small">Preencha os campos abaixo apenas se desejar alterar sua senha.</p>
              <div class="row">
                <div class="col-md-4 mb-3">{{ render_field(form.senha_atual, attrs={'type': 'password'}) }}</div>
                <div class="col-md-4 mb-3">
                  {{ form.nova_senha.label(class="form-label") }}
                  <div class="input-group">
                    {{ form.nova_senha(class="form-control", id="senha") }}
                    <button
                      class="btn btn-outline-secondary"
                      type="button"
                      id="toggleSenha"
                      title="Mostrar/Ocultar Senha"
                    >
                      <i class="fas fa-eye" id="toggleSenhaIcon"></i>
                    </button>
                  </div>
                  {% if form.nova_senha.errors %}
                    <div class="text-danger">{% for error in form.nova_senha.errors %}{{ error }}{% endfor %}</div>
                  {% endif %}
                </div>
                <div class="col-md-4 mb-3">
                  {{ form.confirmar_nova_senha.label(class="form-label") }}
                  <div class="input-group">
                    {{
                      form.confirmar_nova_senha(class="form-control",
                      id="confirmar_senha")
                    }}
                    <button
                      class="btn btn-outline-secondary"
                      type="button"
                      id="toggleConfirmarSenha"
                      title="Mostrar/Ocultar Senha"
                    >
                      <i class="fas fa-eye" id="toggleConfirmarSenhaIcon"></i>
                    </button>
                  </div>
                </div>
              </div>
            {% endif %}

            <div class="progress mt-2" style="height: 5px">
              <div
                id="password-strength-bar"
                class="progress-bar"
                role="progressbar"
                style="width: 0%"
                aria-valuenow="0"
                aria-valuemin="0"
                aria-valuemax="100"
              ></div>
            </div>
            <small id="password-strength-text" class="form-text text-muted"></small>

            <div class="mt-1">
              <button type="submit" class="btn btn-azul">
                <i class="fas fa-save text-warning me-2"></i>
                {{ form.submit.label.text }}
              </button>
              <a href="{{ url_for('main.dashboard') }}" class="btn btn-cinza">Cancelar</a>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
{% endblock %}
{% block scripts %}
  <script src="{{ url_for('static', filename='js/forms.js') }}"></script>
  <script src="{{ url_for('static', filename='js/ajax-forms.js') }}"></script>
{% endblock %}
