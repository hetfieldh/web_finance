<!--- app\templates\relatorios\gastos_por_grupo.html -->

{% extends "base.html" %} {% from "includes/_macros.html" import render_field %}
{% block content %}
<div class="caixa-sombreada mb-2">
  <span class="text-dark fw-bold">Gastos no Crediário: </span>
  <span class="text-danger"
    >Soma de todos movimentos de crediário no ano selecionado, agrupados pela
    visualização escolhida.</span
  >
</div>

<div class="card shadow-sm mb-2">
  <div class="card-body">
    <form
      method="GET"
      action="{{ url_for('relatorios.gastos_por_grupo') }}"
      class="row g-2 align-items-end"
    >
      <div class="col-md-1">{{ render_field(form.ano) }}</div>
      <div class="col-md-2">{{ render_field(form.visualizacao) }}</div>
      <div class="col-md-1">
        <button type="submit" class="btn btn-azul">
          <i class="fas fa-filter me-1 text-warning"></i> Filtrar
        </button>
      </div>
    </form>
  </div>
</div>

<div class="card mb-2 border-0">
  <div class="card-body p-0">
    <div class="row g-2 text-center">
      <div class="col">
        <div class="border rounded p-1">
          <div class="text-muted small fw-bold">Próprio</div>
          <div
            class="h6 mb-0 {% if dados_destino and dados_destino['Próprio'].valor >= 0 %}text-danger{% else %}text-success{% endif %}"
          >
            {{ dados_destino['Próprio'].valor | format_number if dados_destino
            else 0 | format_number }}
          </div>
          <div class="text-muted extra-small">
            ({{ dados_destino['Próprio'].percentual if dados_destino else 0 }}%)
          </div>
        </div>
      </div>

      <div class="col">
        <div class="border rounded p-1">
          <div class="text-muted small fw-bold">Outros</div>
          <div
            class="h6 mb-0 {% if dados_destino and dados_destino['Outros'].valor >= 0 %}text-danger{% else %}text-success{% endif %}"
          >
            {{ dados_destino['Outros'].valor | format_number if dados_destino
            else 0 | format_number }}
          </div>
          <div class="text-muted extra-small">
            ({{ dados_destino['Outros'].percentual if dados_destino else 0 }}%)
          </div>
        </div>
      </div>

      <div class="col">
        <div class="border rounded p-1">
          <div class="text-muted small fw-bold">Coletivo</div>
          <div
            class="h6 mb-0 {% if dados_destino and dados_destino['Coletivo'].valor >= 0 %}text-danger{% else %}text-success{% endif %}"
          >
            {{ dados_destino['Coletivo'].valor | format_number if dados_destino
            else 0 | format_number }}
          </div>
          <div class="text-muted extra-small">
            ({{ dados_destino['Coletivo'].percentual if dados_destino else 0
            }}%)
          </div>
        </div>
      </div>

      <div class="col">
        <div class="border border-secondary rounded p-1 bg-secondary-subtle">
          <div class="text-dark small fw-bold">TOTAL</div>
          <div
            class="h6 mb-0 fw-bold {% if dados_destino and dados_destino['Total Geral'].valor >= 0 %}text-danger{% else %}text-success{% endif %}"
          >
            {{ dados_destino['Total Geral'].valor | format_number if
            dados_destino else 0 | format_number }}
          </div>
          <div class="text-muted extra-small">(100.0%)</div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="card shadow-sm mb-2">
  <div class="card-header menu-primario">
    <h6 class="mb-0">
      <i class="fas text-warning fa-chart-pie me-2"></i> {{ titulo_tabela or
      'Gastos' }}
    </h6>
  </div>
  <div class="card-body">
    {% if dados_tabela %}
    <div class="table-responsive">
      <table class="table table-striped table-hover sortable-table table-sm w-100">
        <thead>
          <tr>
            <th class="text-center">Pos.</th>

            {% if visualizacao_selecionada == 'grupo' %}
            <th>Grupo</th>
            {% elif visualizacao_selecionada == 'subgrupo' %}
            <th>Subgrupo</th>
            {% elif visualizacao_selecionada == 'fornecedor' %}
            <th>Loja/Serviço</th>
            {% endif %}

            <th class="text-center">Nº Compras</th>
            <th class="text-end">Total</th>
          </tr>
        </thead>
        <tbody>
          {% for item in dados_tabela %}
          <tr>
            <td class="text-center">{{ loop.index }}</td>
            <td>
              {% if visualizacao_selecionada == 'grupo' %}
              <a
                href="{{ url_for('relatorios.crediario_resumo', grupo_id=item.id, ano=ano_selecionado) }}"
                class="text-decoration-none text-dark fw-semibold"
              >
                {{ item.nome }}
                <i class="fas fa-arrow-alt-circle-right text-danger ms-1"></i>
              </a>
              {% else %}
              <span class="fw-semibold text-capitalize">{{ item.nome }}</span>
              {% endif %}
            </td>
            <td class="text-center">{{ item.contagem }}</td>
            <td
              class="text-end fw-semibold {% if item.total >= 0 %}text-danger{% else %}text-success{% endif %}"
            >
              {{ item.total | format_number }}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% elif not ano_selecionado %}
    <p class="text-center alert alert-warning">
      Por favor, selecione um ano para filtrar.
    </p>
    {% else %}
    <p class="text-center alert alert-info">
      Nenhum dado de crediário encontrado para o ano de {{ ano_selecionado }}
      com a visualização selecionada.
    </p>
    {% endif %}
  </div>
</div>
{% endblock %}
