<!--- app\templates\relatorios\gastos_por_grupo.html -->

{% extends "base.html" %} {% from "includes/_macros.html" import render_field %}
{% block content %}
  <div class="caixa-sombreada">
    <span class="text-dark fw-bold">Gastos no Crediário:</span>
    <span class="text-danger small d-block d-md-inline">Soma dos movimentos de crediário no ano selecionado.</span>
  </div>
  <div class="card border-0 bg-transparent">
    <div class="card-body p-2">
      <form
        method="GET"
        action="{{ url_for('relatorios.gastos_por_grupo') }}"
        class="d-flex flex-wrap align-items-end gap-2"
      >
        <div class="col-auto">{{ render_field(form.ano) }}</div>
        <div class="col-auto">{{ render_field(form.visualizacao) }}</div>
        <div class="col-auto">
          <button type="submit" class="btn btn-azul">
            <i class="fas fa-filter me-1 text-warning"></i>
            Filtrar
          </button>
        </div>
      </form>
    </div>
  </div>

  <div class="card mb-2 border-0 bg-transparent">
    <div class="card-body p-0">
      <div class="row g-2 text-center">
        <div class="col-6 col-md-3">
          <div class="border rounded p-1 bg-white shadow-sm">
            <div class="text-muted small fw-bold">Próprio</div>
            <div
              class="h6 mb-0 {% if dados_destino and dados_destino['Próprio'].valor >= 0 %}text-danger{% else %}text-success{% endif %}"
            >
              {{
                dados_destino['Próprio'].valor | format_number if dados_destino
                else 0 | format_number
              }}
            </div>
            <div class="text-muted extra-small">
              ({{ dados_destino['Próprio'].percentual if dados_destino else 0 }}%)
            </div>
          </div>
        </div>

        <div class="col-6 col-md-3">
          <div class="border rounded p-1 bg-white shadow-sm ">
            <div class="text-muted small fw-bold">Outros</div>
            <div
              class="h6 mb-0 {% if dados_destino and dados_destino['Outros'].valor >= 0 %}text-danger{% else %}text-success{% endif %}"
            >
              {{
                dados_destino['Outros'].valor | format_number if dados_destino
                else 0 | format_number
              }}
            </div>
            <div class="text-muted extra-small">
              ({{ dados_destino['Outros'].percentual if dados_destino else 0 }}%)
            </div>
          </div>
        </div>

        <div class="col-6 col-md-3">
          <div class="border rounded p-1 bg-white shadow-sm">
            <div class="text-muted small fw-bold">Coletivo</div>
            <div
              class="h6 mb-0 {% if dados_destino and dados_destino['Coletivo'].valor >= 0 %}text-danger{% else %}text-success{% endif %}"
            >
              {{
                dados_destino['Coletivo'].valor | format_number if dados_destino
                else 0 | format_number
              }}
            </div>
            <div class="text-muted extra-small">
              ({{ dados_destino['Coletivo'].percentual if dados_destino else 0 }}%)
            </div>
          </div>
        </div>

        <div class="col-6 col-md-3">
          <div class="border border-secondary-subtle rounded p-1 bg-secondary-subtle shadow-sm">
            <div class="text-dark small fw-bold">TOTAL GERAL</div>
            <div
              class="h6 mb-0 fw-bold {% if dados_destino and dados_destino['Total Geral'].valor >= 0 %}text-danger{% else %}text-success{% endif %}"
            >
              {{
                dados_destino['Total Geral'].valor | format_number if
                dados_destino else 0 | format_number
              }}
            </div>
            <div class="text-muted extra-small">(100.0%)</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card shadow-sm mb-2">
    <div class="card-header menu-primario text-white py-2">
      <h6 class="mb-0">
        <i class="fas fa-chart-pie me-2 text-warning"></i>
        {{
          titulo_tabela or
          'Gastos Detalhados'
        }}
      </h6>
    </div>

    <div class="card-body p-0 p-md-0">
      {% if dados_tabela %}
        <div class="table-responsive d-none d-md-block">
          <table class="table table-striped table-hover sortable-table table-sm w-100 mb-0">
            <thead>
              <tr>
                <th class="text-center" style="width: 50px">Pos.</th>
                {% if visualizacao_selecionada == 'grupo' %}
                  <th>Grupo</th>
                {% elif visualizacao_selecionada == 'subgrupo' %}
                  <th>Subgrupo</th>
                {% elif visualizacao_selecionada == 'fornecedor' %}
                  <th>Loja/Serviço</th>
                {% endif %}
                <th class="text-center">Nº Compras</th>
                <th class="text-end">Total</th>
              </tr>
            </thead>
            <tbody>
              {% for item in dados_tabela %}
                <tr>
                  <td class="text-center fw-bold text-muted">{{ loop.index }}</td>
                  <td>
                    {% if visualizacao_selecionada == 'grupo' %}
                      <a
                        href="{{ url_for('relatorios.crediario_resumo', grupo_id=item.id, ano=ano_selecionado) }}"
                        class="text-decoration-none text-dark fw-semibold"
                      >
                        {{ item.nome }}
                        <i class="fas fa-arrow-alt-circle-right text-primary ms-1 small"></i>
                      </a>
                    {% else %}
                      <span class="fw-semibold text-capitalize">{{ item.nome }}</span>
                    {% endif %}
                  </td>
                  <td class="text-center">{{ item.contagem }}</td>
                  <td class="text-end fw-semibold {% if item.total >= 0 %}text-danger{% else %}text-success{% endif %}">
                    {{ item.total | format_number }}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="d-md-none">
          <ul class="list-group list-group-flush">
            {% for item in dados_tabela %}
              <li class="list-group-item p-2 d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center" style="overflow: hidden">
                  <span class="badge bg-light text-secondary border me-2">{{ loop.index }}</span>
                  <div class="text-truncate">
                    {% if visualizacao_selecionada == 'grupo' %}
                      <a
                        href="{{ url_for('relatorios.crediario_resumo', grupo_id=item.id, ano=ano_selecionado) }}"
                        class="text-decoration-none text-dark fw-bold d-block text-truncate"
                      >
                        {{ item.nome }}
                      </a>
                    {% else %}
                      <span class="fw-bold text-dark d-block text-truncate">{{ item.nome }}</span>
                    {% endif %}
                    <span class="extra-small text-muted">{{ item.contagem }} compras</span>
                  </div>
                </div>

                <div class="text-end ms-2">
                  <span class="d-block fw-bold {% if item.total >= 0 %}text-danger{% else %}text-success{% endif %}">
                    {{ item.total | format_number }}
                  </span>
                  {% if visualizacao_selecionada == 'grupo' %}
                    <a
                      href="{{ url_for('relatorios.crediario_resumo', grupo_id=item.id, ano=ano_selecionado) }}"
                      class="text-decoration-none small text-primary"
                    >
                      Detalhes
                      <i class="fas fa-chevron-right extra-small"></i>
                    </a>
                  {% endif %}
                </div>
              </li>
            {% endfor %}
          </ul>
        </div>
      {% elif not ano_selecionado %}
        <div class="p-3 text-center">
          <p class="alert alert-warning mb-0">Por favor, selecione um ano para filtrar.</p>
        </div>
      {% else %}
        <div class="p-3 text-center">
          <p class="alert alert-info mb-0">Nenhum dado encontrado para o ano {{ ano_selecionado }}.</p>
        </div>
      {% endif %}
    </div>
  </div>
{% endblock %}
