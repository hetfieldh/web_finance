<!-- app/templates/crediario_faturas/list.html -->

{% extends "base.html" %}
{%
  from "includes/_macros.html" import
  render_confirm_modal
%}
{% block content %}
  <div class="row">
    <div class="col-12">
      <div
        class="caixa-sombreada-cinza p-2 d-flex flex-column flex-md-row justify-content-between align-items-center mb-2 gap-2"
      >
        <h5 class="mb-0 me-2 d-flex align-items-center" style="color: var(--wf-azul-destaque)">
          <i class="fab px-2 fa-innosoft fa-lg text-warning"></i>
          Faturas de Crediário
        </h5>

        <div class="d-flex w-md-auto justify-content-end gap-2">
          <button
            type="button"
            id="btn-excluir-massa"
            class="btn btn-danger btn-sm flex-grow-1 flex-md-grow-0 d-none"
            data-bs-toggle="modal"
            data-bs-target="#confirmMassDeleteModal"
          >
            <i class="fas fa-trash-alt me-1"></i>
            Excluir (
            <span id="count-selected">0</span>
            )
          </button>

          <button
            type="button"
            class="btn btn-azul btn-sm flex-grow-1 flex-md-grow-0"
            data-bs-toggle="modal"
            data-bs-target="#confirmFaturasModal"
          >
            <i class="fas fa-sync-alt text-warning me-1"></i>
            Sincronizar
          </button>
        </div>
      </div>

      <div class="modal fade" id="confirmFaturasModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header bg-dark text-white">
              <h5 class="modal-title">
                <i class="fas fa-sync-alt me-2"></i>
                Sincronizar
              </h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">Vamos sincronizar todas as compras nas faturas que ainda não foram pagas.</div>
            <div class="modal-footer">
              <button type="button" class="btn btn-cinza" data-bs-dismiss="modal">Cancelar</button>
              <form action="{{ url_for('crediario_fatura.automatizar_faturas') }}" method="POST">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                <button type="submit" class="btn btn-dark">Sim, continuar</button>
              </form>
            </div>
          </div>
        </div>
      </div>

      <div class="card border-0 bg-transparent mb-2">
        <div class="card-body p-1">
          <form
            action="{{ url_for('crediario_fatura.listar_faturas') }}"
            method="get"
            class="d-flex align-items-center justify-content-center gap-2 flex-wrap"
          >
            <input
              type="date"
              class="form-control form-control-sm"
              style="width: auto; max-width: 110px"
              name="data_inicial"
              value="{{ data_inicial or '' }}"
            />
            <span class="text-muted small">-</span>
            <input
              type="date"
              class="form-control form-control-sm"
              style="width: auto; max-width: 110px"
              name="data_final"
              value="{{ data_final or '' }}"
            />
            <button type="submit" class="btn btn-azul btn-sm">
              <i class="fas fa-search"></i>
            </button>
            <a href="{{ url_for('crediario_fatura.listar_faturas') }}" class="btn btn-cinza btn-sm">
              <i class="fas fa-eraser"></i>
            </a>
          </form>
        </div>
      </div>

      <form id="form-mass-delete" action="{{ url_for('crediario_fatura.excluir_em_massa') }}" method="POST">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

        <div>
          <div>
            {% if faturas %}
              <div class="table-responsive d-none d-lg-block p-0">
                <div class="card border-1">
                  <div class="card-body p-0">
                    <table class="table table-striped table-hover sortable-table mb-0">
                      <thead>
                        <tr>
                          <th class="text-center" style="width: 40px">
                            <input type="checkbox" class="form-check-input" id="select-all-desktop" />
                          </th>
                          <th title="Sincronia"><i class="fas fa-sync-alt"></i></th>
                          <th>ID</th>
                          <th>Crediário</th>
                          <th>Mês/Ano</th>
                          <th>Vencimento</th>
                          <th>Valor Total</th>
                          <th>Pago</th>
                          <th>Status</th>
                          <th>Registro</th>
                          <th class="text-center">Ações</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for item in faturas %}
                          <tr>
                            <td class="text-center">
                              <input
                                type="checkbox"
                                name="item_ids"
                                value="{{ item.fatura.id }}"
                                class="form-check-input item-checkbox"
                              />
                            </td>
                            <td class="{% if item.destaque_status == 'Atrasado' %}text-danger{% endif %}">
                              {% if item.desatualizada %}
                                <i class="fas fa-exclamation-triangle text-danger" title="Desatualizada"></i>
                              {% else %}
                                <i class="fas fa-check-circle text-success" title="Atualizada"></i>
                              {% endif %}
                            </td>
                            <td>{{ item.fatura.id }}</td>
                            <td>{{ item.fatura.crediario.nome_crediario }}</td>
                            <td data-order="{{ item.fatura.mes_referencia }}">
                              {% set partes = item.fatura.mes_referencia.split('-') %}
                              {{ partes[1] }}-{{ partes[0] }}
                            </td>
                            <td class="{% if item.destaque_status == 'Atrasado' %}text-danger fw-bold{% endif %}">
                              <span style="display: none">
                                {{ item.fatura.data_vencimento_fatura.strftime('%Y%m%d') }}
                              </span>
                              {% if item.destaque_status == 'Atrasado' %}
                                <i class="fas fa-exclamation-circle me-1"></i>
                              {% endif %}
                              {{ item.fatura.data_vencimento_fatura.strftime('%d/%m/%Y') }}
                            </td>
                            <td class="fw-bold">{{ item.fatura.valor_total_fatura | format_number }}</td>
                            <td class="text-muted">{{ item.fatura.valor_pago_fatura | format_number }}</td>
                            <td>
                              {% if item.fatura.status == 'Pago' %}
                                <span class="badge bg-success-subtle text-success-emphasis">Pago</span>
                              {% elif item.fatura.status == 'Atrasado' %}
                                <span class="badge bg-danger-subtle text-danger-emphasis">Atrasado</span>
                              {% else %}
                                <span class="badge bg-secondary-subtle text-secondary-emphasis">
                                  {{ item.fatura.status }}
                                </span>
                              {% endif %}
                            </td>
                            <td>
                              <span style="display: none">{{ item.fatura.data_criacao.strftime('%Y%m%d') }}</span>
                              {{ item.fatura.data_criacao.strftime('%d/%m/%Y') }}
                            </td>
                            <td class="table-actions text-center">
                              <a
                                href="{{ url_for('crediario_fatura.visualizar_fatura', id=item.fatura.id) }}"
                                class="btn btn-amarelo me-2"
                              >
                                <i class="fas fa-eye text-danger"></i>
                              </a>
                            </td>
                          </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

              <div class="d-lg-none">
                <div class="list-group">
                  <div class="list-group-item bg-light p-2 mb-2 rounded border">
                    <div class="form-check mb-0">
                      <input class="form-check-input" type="checkbox" id="select-all-mobile" />
                      <label class="form-check-label small text-dark fw-bold" for="select-all-mobile">
                        Selecionar Todos
                      </label>
                    </div>
                  </div>

                  {% for item in faturas %}
                    <div
                      class="list-group-item p-2 border-start mb-1 rounded border-1 {% if item.destaque_status == 'Atrasado' %}border-danger{% elif item.fatura.status == 'Pago' %}border-success{% endif %}"
                    >
                      <div class="d-flex gap-2">
                        <div class="d-flex align-items-center">
                          <input
                            type="checkbox"
                            name="item_ids"
                            value="{{ item.fatura.id }}"
                            class="form-check-input item-checkbox"
                            style="transform: scale(1.3)"
                          />
                        </div>

                        <div class="flex-grow-1">
                          <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="fw-medium text-dark text-truncate" style="max-width: 160px">
                              {{ item.fatura.crediario.nome_crediario }}
                            </span>
                            <span class="badge bg-light text-dark border small">
                              {% set partes = item.fatura.mes_referencia.split('-') %}
                              {{ partes[1] }}/{{ partes[0] }}
                            </span>
                          </div>

                          <div class="d-flex justify-content-between align-items-center mb-1">
                            <span
                              class="fw-bold {% if item.destaque_status == 'Atrasado' %}text-danger{% else %}text-primary{% endif %}"
                            >
                              {{ item.fatura.valor_total_fatura | format_number }}
                            </span>
                            {% if item.fatura.status == 'Pago' %}
                              <span class="badge bg-success-subtle text-success-emphasis extra-small">Pago</span>
                            {% elif item.fatura.status == 'Atrasado' %}
                              <span class="badge bg-danger-subtle text-danger-emphasis extra-small">Atrasado</span>
                            {% else %}
                              <span class="badge bg-secondary-subtle text-secondary-emphasis extra-small">
                                {{ item.fatura.status }}
                              </span>
                            {% endif %}
                          </div>

                          <div class="d-flex justify-content-between align-items-end mt-1">
                            <div class="small text-muted d-flex align-items-center">
                              <i class="far fa-calendar-alt me-1"></i>
                              {{ item.fatura.data_vencimento_fatura.strftime('%d/%m') }}
                              {% if item.desatualizada %}
                                <i class="fas fa-exclamation-triangle text-danger ms-2" title="Desatualizada"></i>
                              {% endif %}
                            </div>
                            <a
                              href="{{ url_for('crediario_fatura.visualizar_fatura', id=item.fatura.id) }}"
                              class="btn btn-sm py-1 px-2"
                            >
                              <i class="fas fa-eye text-danger"></i>
                            </a>
                          </div>
                        </div>
                      </div>
                    </div>
                  {% endfor %}
                </div>
              </div>
            {% else %}
              <div class="card border-1">
                <div class="card-body text-center py-4">
                  <p class="text-muted mb-0">Nenhuma fatura cadastrada.</p>
                </div>
              </div>
            {% endif %}
          </div>
        </div>
      </form>
    </div>
  </div>

  <div class="modal fade" id="confirmMassDeleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title">
            <i class="fas fa-trash-alt me-2"></i>
            Excluir Selecionados
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          Tem certeza que deseja excluir as faturas selecionadas?
          <br />
          <small class="text-muted">Nota: Faturas já pagas serão ignoradas.</small>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-cinza" data-bs-dismiss="modal">Cancelar</button>
          <button type="button" class="btn btn-danger" onclick="document.getElementById('form-mass-delete').submit();">
            Sim, Excluir
          </button>
        </div>
      </div>
    </div>
  </div>

  {{
    render_confirm_modal( modal_id='confirmDeleteModal', title='Confirmar
    Exclusão', body_text='Excluir?', confirm_button_text='Sim' )
  }}
{% endblock %}
