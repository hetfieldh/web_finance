<!-- app/templates/crediario_faturas/list.html -->

{% extends "base.html" %} {% from "includes/_macros.html" import
render_confirm_modal %} {% block content %}
<div class="row">
  <div class="col-12">
    <div
      class="caixa-sombreada-cinza p-2 d-flex flex-column flex-md-row justify-content-between align-items-center mb-2 gap-2"
    >
      <h5
        class="mb-0 me-2 d-flex align-items-center"
        style="color: var(--wf-azul-destaque)"
      >
        <i class="fab px-2 fa-innosoft fa-lg text-warning"></i>
        Faturas de Crediário
      </h5>

      <div class="d-flex w-md-auto justify-content-end">
        <button
          type="button"
          class="btn btn-azul btn-sm flex-grow-1 flex-md-grow-0"
          data-bs-toggle="modal"
          data-bs-target="#confirmFaturasModal"
        >
          <i class="fas fa-sync-alt text-warning me-1"></i> Sincronizar Faturas
        </button>
      </div>
    </div>

    <div
      class="modal fade"
      id="confirmFaturasModal"
      tabindex="-1"
      aria-labelledby="confirmFaturasLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header bg-dark text-white">
            <div class="position-relative w-100">
              <i
                class="fas fa-2x fa-question-circle text-white position-absolute start-0 top-50 translate-middle-y ms-2"
              ></i>
              <h4 class="modal-title text-center m-0" id="confirmFaturasLabel">
                Sincronizar Faturas
              </h4>
            </div>
            <button
              type="button"
              class="btn-close btn-sm"
              data-bs-dismiss="modal"
              aria-label="Fechar"
            ></button>
          </div>
          <div class="modal-body">
            Vamos sincronizar todas as compras nas faturas que ainda não foram
            pagas. Gostaria de continuar?
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-cinza" data-bs-dismiss="modal">
              Cancelar
            </button>
            <form
              action="{{ url_for('crediario_fatura.automatizar_faturas') }}"
              method="POST"
              style="display: inline"
            >
              <button type="submit" class="btn btn-dark">Sim, continuar</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="card border-0 mb-2">
      <div class="card-body p-1">
        <form
          action="{{ url_for('crediario_fatura.listar_faturas') }}"
          method="get"
          class="d-flex align-items-center justify-content-center gap-1 flex-wrap"
        >
          <input
            type="date"
            class="form-control form-control-sm"
            style="width: auto; max-width: 130px"
            id="data_inicial"
            name="data_inicial"
            value="{{ data_inicial if data_inicial else '' }}"
            title="Data Inicial"
          />

          <span class="text-muted small">-</span>

          <input
            type="date"
            class="form-control form-control-sm"
            style="width: auto; max-width: 130px"
            id="data_final"
            name="data_final"
            value="{{ data_final if data_final else '' }}"
            title="Data Final"
          />

          <button type="submit" class="btn btn-azul btn-sm" title="Filtrar">
            <i class="fas fa-search"></i>
          </button>

          <a
            href="{{ url_for('crediario_fatura.listar_faturas') }}"
            class="btn btn-cinza btn-sm"
            title="Limpar Filtros"
          >
            <i class="fas fa-eraser"></i>
          </a>
        </form>
      </div>
    </div>

    <div>
      <div>
        {% if faturas %}

        <div class="table-responsive d-none d-lg-block p-0">
          <div class="card border-1">
            <div class="card-body p-0">
              <table
                class="table table-striped table-hover sortable-table mb-0"
              >
                <thead>
                  <tr>
                    <th>ID</th>
                    <th title="Sincronia"><i class="fas fa-sync-alt"></i></th>
                    <th>Crediário</th>
                    <th>Mês/Ano</th>
                    <th>Vencimento</th>
                    <th>Valor Total</th>
                    <th>Valor Pago</th>
                    <th>Status</th>
                    <th>Registro</th>
                    <th class="text-center">Ações</th>
                  </tr>
                </thead>
                <tbody>
                  {% for item in faturas %}
                  <tr>
                    <td
                      class="{% if item.destaque_status == 'Atrasado' %}fw-bold text-danger{% elif item.destaque_status == 'vence_este_mes' %}fw-bold text-dark{% endif %}"
                    >
                      {{ item.fatura.id }}
                    </td>
                    <td
                      class="{% if item.destaque_status == 'Atrasado' %}fw-bold text-danger{% elif item.destaque_status == 'vence_este_mes' %}fw-bold text-info{% endif %}"
                    >
                      {% if item.desatualizada %}
                      <i
                        class="fas fa-exclamation-triangle text-danger"
                        data-bs-toggle="tooltip"
                        title="Desatualizada!"
                      ></i>
                      {% else %}
                      <i
                        class="fas fa-check-circle text-success"
                        data-bs-toggle="tooltip"
                        title="Atualizada"
                      ></i>
                      {% endif %}
                    </td>
                    <td
                      class="{% if item.destaque_status == 'Atrasado' %}fw-bold text-danger{% elif item.destaque_status == 'vence_este_mes' %}fw-bold text-dark{% endif %}"
                    >
                      {{ item.fatura.crediario.nome_crediario }}
                      ({{item.fatura.crediario.tipo_crediario}})
                    </td>
                    <td
                      class="{% if item.destaque_status == 'Atrasado' %}fw-bold text-danger{% elif item.destaque_status == 'vence_este_mes' %}fw-bold text-dark{% endif %}"
                    >
                      {% set partes = item.fatura.mes_referencia.split('-') %}
                      {{ partes[1] }}-{{ partes[0] }}
                    </td>
                    <td
                      class="{% if item.destaque_status == 'Atrasado' %}fw-bold text-danger{% elif item.destaque_status == 'vence_este_mes' %}fw-bold text-dark{% endif %}"
                    >
                      {% if item.destaque_status == 'Atrasado' %}
                      <i
                        class="fas fa-exclamation-circle me-1"
                        title="FATURA ATRASADA!"
                      ></i>
                      {% elif item.destaque_status == 'vence_este_mes' %}
                      <i class="fas fa-bell me-1" title="Vence este mês!"></i>
                      {% endif %} {{
                      item.fatura.data_vencimento_fatura.strftime('%d/%m/%Y') }}
                    </td>
                    <td
                      class="{% if item.destaque_status == 'Atrasado' %}fw-bold text-danger{% elif item.destaque_status == 'vence_este_mes' %}fw-bold text-dark{% endif %}"
                    >
                      {{item.fatura.valor_total_fatura | format_currency }}
                    </td>
                    <td
                      class="{% if item.destaque_status == 'Atrasado' %}fw-bold text-danger{% elif item.destaque_status == 'vence_este_mes' %}fw-bold text-dark{% endif %}"
                    >
                      {{item.fatura.valor_pago_fatura | format_currency }}
                    </td>
                    <td>
                      {% if item.fatura.status == 'Pago' %}
                      <span
                        class="badge bg-success-subtle text-success-emphasis"
                        >{{ item.fatura.status }}</span
                      >
                      {% elif item.fatura.status == 'Atrasado' %}
                      <span class="badge bg-danger-subtle text-danger-emphasis"
                        >{{ item.fatura.status }}</span
                      >
                      {% elif item.fatura.status == 'Parcialmente Paga' %}
                      <span
                        class="badge bg-warning-subtle text-warning-emphasis"
                        >{{ item.fatura.status }}</span
                      >
                      {% else %}
                      <span
                        class="badge bg-secondary-subtle text-secondary-emphasis"
                        >{{ item.fatura.status }}</span
                      >
                      {% endif %}
                    </td>
                    <td
                      class="{% if item.destaque_status == 'Atrasado' %}fw-bold text-danger{% elif item.destaque_status == 'vence_este_mes' %}fw-bold text-dark{% endif %}"
                    >
                      {{ item.fatura.data_criacao.strftime('%d/%m/%Y') }}
                    </td>
                    <td class="table-actions text-center">
                      <a
                        href="{{ url_for('crediario_fatura.visualizar_fatura', id=item.fatura.id) }}"
                        class="btn btn-amarelo me-2"
                        title="Visualizar"
                      >
                        <i class="fas fa-eye"></i>
                      </a>
                      <button
                        type="button"
                        class="btn btn-danger"
                        data-bs-toggle="modal"
                        data-bs-target="#confirmDeleteModal"
                        data-form-action="{{ url_for('crediario_fatura.excluir_fatura', id=item.fatura.id) }}"
                        title="Excluir"
                      >
                        <i class="fas fa-trash-alt"></i>
                      </button>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="d-lg-none">
          <div class="list-group">
            {% for item in faturas %}
            <div
              class="list-group-item p-1 border-start mb-1 rounded border-1 border-secondary {% if item.destaque_status == 'Atrasado' or item.desatualizada %}border-danger {% elif item.fatura.status == 'Pago' %}border-success {% elif item.destaque_status == 'vence_este_mes' %}border-info{% endif %}"
            >
              <div
                class="d-flex justify-content-between align-items-center mb-1"
              >
                <span
                  class="fw-medium text-dark text-truncate me-2"
                  style="max-width: 60%"
                >
                  {{ item.fatura.crediario.nome_crediario }}
                </span>
                <span class="badge bg-light text-dark border small">
                  {% set partes = item.fatura.mes_referencia.split('-') %} {{
                  partes[1] }}/{{ partes[0] }}
                </span>
              </div>

              <div
                class="d-flex justify-content-between align-items-center mb-1"
              >
                <div>
                  <span
                    class="fw-bold {% if item.destaque_status == 'Atrasado' %}text-danger{% else %}text-primary{% endif %}"
                  >
                    {{ item.fatura.valor_total_fatura | format_currency }}
                  </span>
                  {% if item.fatura.valor_pago_fatura > 0 %}
                  <small class="text-success ms-1"
                    >({{ item.fatura.valor_pago_fatura | format_currency
                    }})</small
                  >
                  {% endif %}
                </div>
                {% if item.fatura.status == 'Pago' %}
                <span
                  class="badge bg-success-subtle text-success-emphasis extra-small"
                  >Pago</span
                >
                {% elif item.fatura.status == 'Atrasado' %}
                <span
                  class="badge bg-danger-subtle text-danger-emphasis extra-small"
                  >Atrasado</span
                >
                {% else %}
                <span
                  class="badge bg-secondary-subtle text-secondary-emphasis extra-small"
                  >{{ item.fatura.status }}</span
                >
                {% endif %}
              </div>

              <div class="d-flex justify-content-between align-items-end mt-1">
                <div class="small text-muted d-flex align-items-center">
                  <i class="far fa-calendar-alt me-1"></i> {{
                  item.fatura.data_vencimento_fatura.strftime('%d/%m') }} {% if
                  item.desatualizada %}
                  <i
                    class="fas fa-exclamation-triangle text-danger ms-2"
                    title="Desatualizada"
                  ></i>
                  {% endif %} {% if item.destaque_status == 'vence_este_mes' %}
                  <i
                    class="fas fa-bell text-info ms-2"
                    title="Vence este mês"
                  ></i>
                  {% endif %}
                </div>

                <div class="d-flex gap-1">
                  <a
                    href="{{ url_for('crediario_fatura.visualizar_fatura', id=item.fatura.id) }}"
                    class="btn btn-outline-warning btn-sm py-1 px-2"
                    title="Visualizar"
                  >
                    <i class="fas fa-eye"></i>
                  </a>
                  <button
                    type="button"
                    class="btn btn-outline-danger btn-sm py-1 px-2"
                    data-bs-toggle="modal"
                    data-bs-target="#confirmDeleteModal"
                    data-form-action="{{ url_for('crediario_fatura.excluir_fatura', id=item.fatura.id) }}"
                    title="Excluir"
                  >
                    <i class="fas fa-trash-alt"></i>
                  </button>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>

        {% else %}
        <div class="card border-1">
          <div class="card-body text-center py-4">
            <p class="text-muted mb-0">Nenhuma fatura cadastrada.</p>
          </div>
        </div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{{ render_confirm_modal( modal_id='confirmDeleteModal', title='Confirmar
Exclusão', body_text='Tem certeza que deseja excluir este registro? Esta ação
não pode ser desfeita.', confirm_button_text='Sim, Excluir' ) }} {% endblock %}
